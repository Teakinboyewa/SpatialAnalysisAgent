tool_ID = "grass7:i.landsat.toar"
tool_name = "i.landsat.toar"
brief_description = "i.landsat.toari.landsat.toar- Calculates top-of-atmosphere radiance or reflectance and temperature for Landsat MSS/TM/ETM+/OLI"
synopsis = "i.landsat.toar\ni.landsat.toar --help\ni.landsat.toar[-rnp]input=basenameoutput=basename[metfile=name]   [sensor=string]   [method=string]   [date=yyyy-mm-dd]   [sun_elevation=float]   [product_date=yyyy-mm-dd]   [gain=string]   [percent=float]   [pixel=integer]   [rayleigh=float]   [lsatmet=string[,string,...]]   [scale=float]   [--overwrite]  [--help]  [--verbose]  [--quiet]  [--ui]"
flags = "-r\n    Output at-sensor radiance instead of reflectance for all bands\n-n\n    Input raster maps use as extension the number of the band instead the code\n-p\n    Print output metadata info\n--overwrite\n    Allow output files to overwrite existing files\n--help\n    Print usage summary\n--verbose\n    Verbose module output\n--quiet\n    Quiet module output\n--ui\n    Force launching GUI dialog"
parameters = "input=basename[required]\n    Base name of input raster bands\n    Example: 'B.' for B.1, B.2, ...\noutput=basename[required]\n    Prefix for output raster maps\n    Example: 'B.toar.' generates B.toar.1, B.toar.2, ...\nmetfile=name\n    Name of Landsat metadata file (.met or MTL.txt)\nsensor=string\n    Spacecraft sensor\n    Required only if 'metfile' not given (recommended for sanity)\n    Options:mss1, mss2, mss3, mss4, mss5, tm4, tm5, tm7, oli8\n    mss1: Landsat-1 MSS\n    mss2: Landsat-2 MSS\n    mss3: Landsat-3 MSS\n    mss4: Landsat-4 MSS\n    mss5: Landsat-5 MSS\n    tm4: Landsat-4 TM\n    tm5: Landsat-5 TM\n    tm7: Landsat-7 ETM+\n    oli8: Landsat_8 OLI/TIRS\nmethod=string\n    Atmospheric correction method\n    Options:uncorrected, dos1, dos2, dos2b, dos3, dos4\n    Default:uncorrected\ndate=yyyy-mm-dd\n    Image acquisition date (yyyy-mm-dd)\n    Required only if 'metfile' not given\nsun_elevation=float\n    Sun elevation in degrees\n    Required only if 'metfile' not given\nproduct_date=yyyy-mm-dd\n    Image creation date (yyyy-mm-dd)\n    Required only if 'metfile' not given\ngain=string\n    Gain (H/L) of all Landsat ETM+ bands (1-5,61,62,7,8)\n    Required only if 'metfile' not given\npercent=float\n    Percent of solar radiance in path radiance\n    Required only if 'method' is any DOS\n    Default:0.01\npixel=integer\n    Minimum pixels to consider digital number as dark object\n    Required only if 'method' is any DOS\n    Default:1000\nrayleigh=float\n    Rayleigh atmosphere (diffuse sky irradiance)\n    Required only if 'method' is DOS3\n    Default:0.0\nlsatmet=string[,string,...]\n    return value stored for a given metadata\n    Required only if 'metfile' and -p given\n    Options:number, creation, date, sun_elev, sensor, bands, sunaz, time\n    number: Landsat Number\n    creation: Creation timestamp\n    date: Date\n    sun_elev: Sun Elevation\n    sensor: Sensor\n    bands: Bands count\n    sunaz: Sun Azimuth Angle\n    time: Time\nscale=float\n    Scale factor for output\n    Default:1.0"
document = "(This document is written in markdown format.) \n\n\n\nDESCRIPTION\n-----------\n\n\n*i.landsat.toar* is used to transform the calibrated digital\nnumber of Landsat imagery products to top\\-of\\-atmosphere radiance or\ntop\\-of\\-atmosphere reflectance and temperature (band 6 of the sensors\nTM and ETM\\+). Optionally, it can be used to calculate the at\\-surface\nradiance or reflectance with atmospheric correction (DOS method).\n\n\nUsually, to do so the production date, the acquisition date, and the\nsolar elevation are needed. Moreover, for Landsat\\-7 ETM\\+ it is also\nneeded the gain (high or low) of the nine respective bands.\n\n\n\n\nOptionally (recommended), the data can be read from metadata file\n(.met or MTL.txt) for all Landsat MSS, TM, ETM\\+ and OLI/TIRS. However,\nif the solar elevation is given the value of the metadata file is\noverwritten. This is necessary when the data in the .met file is\nincorrect or not accurate. Also, if acquisition or production dates are\nnot found in the metadata file then the command line values are used.\n\n\n\n\n**Attention**: Any null value or smaller than QCALmin in the input\nraster is set to null in the output raster and it is not included in\nthe equations.\n\n\n\n\n**Attention**: This module does **not** respect the current\nregion settings, in order to have the largest possible sample of pixels\nfrom where to get the darkest one of the scene and perform the DOS\ncorrection. To limit the results to a custom region, the user is\nadvised to clip the results (with [r.clip](r.clip.html), for\ninstance) or to define the region first, import the images with region\ncropping, and then running the module.\n\n\n\nUncorrected at\\-sensor values (method\\=uncorrected, default)\n------------------------------------------------------------\n\n\n\nThe standard geometric and radiometric corrections result in a\ncalibrated digital number (QCAL \\= DN) images. To further standardize\nthe impact of illumination geometry, the QCAL images are first\nconverted first to at\\-sensor radiance and then to at\\-sensor\nreflectance. The thermal band is first converted from QCAL to\nat\\-sensor radiance, and then to effective at\\-sensor temperature in\nKelvin degrees.\n\n\nRadiometric calibration converts QCAL to **at\\-sensor radiance**, a\nradiometric quantity measured in W/(m² \\* sr \\* µm) using the\nequations:\n\n\n* gain \\= (Lmax \\- Lmin) / (QCALmax \\- QCALmin)\n* bias \\= Lmin \\- gain \\* QCALmin\n* radiance \\= gain \\* QCAL \\+ bias\n\n\n\nwhere, *Lmax* and *Lmin* are the calibration constants,\nand *QCALmax* and *QCALmin* are the highest and the\nlowest points of the range of rescaled radiance in QCAL.\n\n\nThen, to calculate **at\\-sensor reflectance** the equations are:\n\n\n\n* sun\\_radiance \\= \\[Esun \\* sin(e)] / (PI \\* d^2\\)\n* reflectance \\= radiance / sun\\_radiance\n\n\n\nwhere, *d* is the earth\\-sun distance in astronomical\nunits, *e* is the solar elevation angle, and *Esun* is\nthe mean solar exoatmospheric irradiance in W/(m² \\* µm).\n\nSimplified at\\-surface values (method\\=dos\\[1\\-4])\n--------------------------------------------------\n\n\n\nAtmospheric correction and reflectance calibration remove the path\nradiance, i.e. the stray light from the atmosphere, and the spectral\neffect of solar illumination. To output these simple **at\\-surface\nradiance** and **at\\-surface reflectance**, the equations are (not\nfor thermal bands):\n\n* sun\\_radiance \\= TAUv \\* \\[Esun \\* sin(e) \\* TAUz \\+ Esky] / (PI \\* d^2\\)\n* radiance\\_path \\= radiance\\_dark \\- percent \\* sun\\_radiance\n* radiance \\= (at\\-sensor\\_radiance \\- radiance\\_path)\n* reflectance \\= radiance / sun\\_radiance\n\n\n\nwhere, *percent* is a value between 0\\.0 and 1\\.0 (usually\n0\\.01\\), *Esky* is the diffuse sky irradiance, *TAUz* is\nthe atmospheric transmittance along the path from the sun to the\nground surface, and *TAUv* is the atmospheric transmittance\nalong the path from the ground surface to the\nsensor. *radiance\\_dark* is the at\\-sensor radiance calculated\nfrom the darkest object, i.e. DN with a least 'dark\\_parameter'\n(usually 1000\\) pixels for the entire image.\n\nThe values are,\n\n* DOS1: TAUv \\= 1\\.0, TAUz \\= 1\\.0 and Esky \\= 0\\.0\n* DOS2: TAUv \\= 1\\.0, Esky \\= 0\\.0, and TAUz \\= sin(e) for all bands\n with maximum wave length less than 1\\. (i.e. bands 4\\-6 MSS, 1\\-4 TM,\n and 1\\-4 ETM\\+) other bands TAUz \\= 1\\.0\n* DOS3: TAUv \\= exp\\[\\-t/cos(sat\\_zenith)],\n TAUz \\= exp\\[\\-t/sin(e)], Esky \\= rayleigh\n* DOS4: TAUv \\= exp\\[\\-t/cos(sat\\_zenith)],\n TAUz \\= exp\\[\\-t/sin(e)], Esky \\= PI \\* radiance\\_dark\n\n\n**Attention**: Output radiance remain untouched (i.e. no set to 0\\.0\nwhen it is negative) then they are possible negative values. However,\noutput reflectance is set to 0\\.0 when is obtained a negative value.\n\nNOTES\n-----\n\n\n\nThe output raster cell values can be rescaled with the **scale**\nparameter (e.g., with 100 in case of using reflectance output\nin *i.gensigset*).\n\n### On Landsat\\-8 metadata file\n\n\n\nNASA reports a structure of the L1G Metadata file\n([LDCM\\-DFCB\\-004\\.pdf](http://landsat.usgs.gov/documents/LDCM-DFCB-004.pdf))\nfor Landsat Data Continuity Mission (i.e. Landsat\\-8\\).\n\n\nNASA retains in MIN\\_MAX\\_RADIANCE group the necessary information\nto transform Digital Numbers (DN) in radiance values. Then,\n*i.landsat.toar* replaces the possible standard values with the\nmetadata values. The results match with the values reported by the\nmetada file in RADIOMETRIC\\_RESCALING group.\n\n\n\n\nAlso, NASA reports the same values of reflectance for all bands\nin max\\-min values and in gain\\-bias values. This is strange that all\nbands have the same range of reflectance. Also, they wrote in the\nweb page as to calculate reflectance directly from DN, first with\nRADIOMETRIC\\_RESCALING values and second divided by sin(sun\\_elevation).\n\n\n\n\nThis is a simple rescaling\n\n\n\n* reflectance \\= radiance / sun\\_radiance \\= (DN \\* RADIANCE\\_MULT \\+ RADIANCE\\_ADD) / sun\\_radiance\n* now reflectance \\= DN \\* REFLECTANCE\\_MULT \\+ REFLECTANCE\\_ADD\n* then REFLECTANCE\\_MULT \\= RADIANCE\\_MULT / sun\\_radiance\n* and REFLECTANCE\\_ADD \\= RADIANCE\\_ADD / sun\\_radiance\n\n\n\nThe problem arises when we need ESUN values (not provided) to\ncompute sun\\_radiance and DOS. We assume that REFLECTANCE\\_MAXIMUM\ncorresponds to the RADIANCE\\_MAXIMUM, then\n\n\n\n* REFLECTANCE\\_MAXIMUM / sin(e) \\= RADIANCE\\_MAXIMUM / sun\\_radiance\n* Esun \\= (PI \\* d^2\\) \\* RADIANCE\\_MAXIMUM / REFLECTANCE\\_MAXIMUM\n\n\n\nwhere *d* is the earth\\-sun distance provided by metadata file\nor computed inside the program.\n\n\nThe *i.landsat.toar* reverts back the NASA rescaling to continue\nusing Lmax, Lmin, and Esun values to compute the constant to convert\nDN to radiance and radiance to reflectance with the \"traditional\"\nequations and simple atmospheric corrections.\n\n**Attention**: When MAXIMUM values are not provided,\n*i.landsat.toar* tries to calculate Lmax, Lmin, and Esun from\nRADIOMETRIC\\_RESCALING (in tests the results were the same).\n\n\n\n### Calibration constants\n\n\nIn verbose mode (flag **\\-\\-verbose**), the program write basic\nsatellite data and the parameters used in the transformations.\n\n\nProduction date is not an exact value but it is necessary to apply\ncorrect calibration constants, which were changed in the dates:\n\n\n* Landsat\\-1 MSS: never\n* Landsat\\-2 MSS: July 16, 1975\n* Landsat\\-3 MSS: June 1, 1978\n* Landsat\\-4 MSS: August 26, 1982 and April 1, 1983\n* Landsat\\-4 TM: August 1, 1983 and January 15, 1984\n* Landsat\\-5 MSS: April 6, 1984 and November 9, 1984\n* Landsat\\-5 TM: May 4, 2003 and April, 2 2007\n* Landsat\\-7 ETM\\+: July 1, 2000\n* Landsat\\-8 OLI/TIRS: launched in 2013\n\n\nEXAMPLES\n--------\n\n\n### Metadata file examples\n\n\n\nTransform digital numbers of Landsat\\-7 ETM\\+ in band rasters 203\\_30\\.1,\n203\\_30\\.2 \\[...] to uncorrected at\\-sensor reflectance in output files\n203\\_30\\.1\\_toar, 203\\_30\\.2\\_toar \\[...] and at\\-sensor temperature in output\nfiles 293\\_39\\.61\\_toar and 293\\_39\\.62\\_toar:\n\n\n```\ni.landsat.toar input=203_30. output=_toar \\\n  metfile=p203r030_7x20010620.met\n\n```\n\n\nor\n\n\n```\ni.landsat.toar input=L5121060_06020060714. \\\n  output=L5121060_06020060714_toar \\\n  metfile=L5121060_06020060714_MTL.txt\n\n```\n\n\nor\n\n\n```\ni.landsat.toar input=LC80160352013134LGN03_B output=toar \\\n  metfile=LC80160352013134LGN03_MTL.txt sensor=oli8 date=2013-05-14\n\n```\n\n### DOS1 example\n\n\n\nDN to reflectance using DOS1:\n\n\n```\n# rename channels or make a copy to match i.landsat.toar's input scheme:\ng.copy raster=lsat7_2002_10,lsat7_2002.1\ng.copy raster=lsat7_2002_20,lsat7_2002.2\ng.copy raster=lsat7_2002_30,lsat7_2002.3\ng.copy raster=lsat7_2002_40,lsat7_2002.4\ng.copy raster=lsat7_2002_50,lsat7_2002.5\ng.copy raster=lsat7_2002_61,lsat7_2002.61\ng.copy raster=lsat7_2002_62,lsat7_2002.62\ng.copy raster=lsat7_2002_70,lsat7_2002.7\ng.copy raster=lsat7_2002_80,lsat7_2002.8\n\n```\n\n\nCalculation of reflectance values from DN using DOS1 (metadata obtained\nfrom [p016r035\\_7x20020524\\.met.gz](http://www.grassbook.org/wp-content/uploads/ncexternal/landsat/2002/p016r035_7x20020524.met.gz)):\n\n\n```\ni.landsat.toar input=lsat7_2002. output=lsat7_2002_toar. sensor=tm7 \\\n  method=dos1 date=2002-05-24 sun_elevation=64.7730999 \\\n  product_date=2004-02-12 gain=HHHLHLHHL\n\n```\n\n\nThe resulting Landsat channels are named lsat7\\_2002\\_toar.1 .. lsat7\\_2002\\_toar.8.\n\n"
